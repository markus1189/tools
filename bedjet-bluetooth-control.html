<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BedJet Bluetooth Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            padding: 30px;
        }

        h1 {
            font-size: 28px;
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-bottom: 25px;
        }

        .status-bar {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            background: #ccc;
        }

        .status-indicator.connected {
            background: #4caf50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .status-text {
            font-weight: 600;
            color: #333;
        }

        .device-name {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #d32f2f;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .state-section {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .state-section h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .state-section h2::before {
            content: "";
            display: inline-block;
            width: 4px;
            height: 18px;
            background: #667eea;
            margin-right: 10px;
            border-radius: 2px;
        }

        .state-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .state-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .state-label {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .state-value {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .state-unit {
            font-size: 16px;
            color: #999;
            margin-left: 3px;
        }

        .control-section {
            margin-bottom: 20px;
        }

        .control-section h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .control-section h2::before {
            content: "";
            display: inline-block;
            width: 4px;
            height: 18px;
            background: #667eea;
            margin-right: 10px;
            border-radius: 2px;
        }

        .mode-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-btn {
            padding: 12px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #666;
        }

        .mode-btn:hover:not(:disabled) {
            border-color: #667eea;
            color: #667eea;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
        }

        .mode-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .slider-control {
            margin-bottom: 20px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
            color: #666;
        }

        .slider-value {
            font-weight: 700;
            color: #667eea;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            border: none;
        }

        input[type="range"]:disabled {
            opacity: 0.5;
        }

        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .preset-btn {
            padding: 12px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #666;
        }

        .preset-btn:hover:not(:disabled) {
            border-color: #764ba2;
            color: #764ba2;
            background: #f5f0ff;
        }

        .preset-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            display: none;
        }

        .error.show {
            display: block;
        }

        .info {
            background: #e3f2fd;
            color: #1565c0;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
            line-height: 1.5;
        }

        .debug-section {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            border: 2px solid #e0e0e0;
        }

        .debug-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
            user-select: none;
        }

        .debug-title {
            font-size: 16px;
            font-weight: 700;
            color: #333;
        }

        .debug-toggle {
            font-size: 12px;
            color: #667eea;
            font-weight: 600;
        }

        .debug-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .debug-btn {
            padding: 8px 12px;
            border: 1px solid #667eea;
            background: white;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            color: #667eea;
            transition: all 0.2s ease;
        }

        .debug-btn:hover {
            background: #667eea;
            color: white;
        }

        .debug-log {
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 6px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            max-height: 300px;
            overflow-y: auto;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .debug-log:empty::before {
            content: "No logs yet. Click 'Connect to BedJet' to start...";
            color: #888;
        }

        .log-entry {
            margin-bottom: 4px;
            padding: 2px 0;
        }

        .log-time {
            color: #858585;
        }

        .log-level-info {
            color: #4ec9b0;
        }

        .log-level-error {
            color: #f48771;
        }

        .log-level-warn {
            color: #dcdcaa;
        }

        .log-level-success {
            color: #89d185;
        }

        .debug-collapsed .debug-log,
        .debug-collapsed .debug-buttons {
            display: none;
        }

        @media (max-width: 480px) {
            .state-grid {
                grid-template-columns: 1fr;
            }

            .mode-buttons {
                grid-template-columns: repeat(2, 1fr);
            }

            .debug-log {
                font-size: 10px;
                max-height: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõèÔ∏è BedJet Control</h1>
        <p class="subtitle">Bluetooth LE Control Panel</p>

        <div class="info">
            <strong>‚ö†Ô∏è Browser Requirement:</strong> This tool requires a browser with Web Bluetooth API support (Chrome, Edge, or Opera on desktop/Android).
        </div>

        <div id="error" class="error"></div>

        <div class="status-bar">
            <div>
                <span class="status-indicator" id="statusIndicator"></span>
                <span class="status-text" id="statusText">Not Connected</span>
            </div>
            <div class="device-name" id="deviceName"></div>
        </div>

        <div style="margin-bottom: 15px; padding: 12px; background: #f9f9f9; border-radius: 8px;">
            <label style="display: flex; align-items: center; cursor: pointer; font-size: 14px; color: #666;">
                <input type="checkbox" id="showAllDevices" style="margin-right: 8px; cursor: pointer;">
                <span>Show all Bluetooth devices (use if BedJet not found)</span>
            </label>
        </div>

        <button id="connectBtn" class="btn btn-primary">Connect to BedJet</button>
        <button id="disconnectBtn" class="btn btn-danger" style="display: none;">Disconnect</button>

        <div id="controls" style="display: none;">
            <div class="state-section">
                <h2>Current State</h2>
                <div class="state-grid">
                    <div class="state-item">
                        <div class="state-label">Current Temp</div>
                        <div class="state-value">
                            <span id="currentTemp">--</span><span class="state-unit">¬∞F</span>
                        </div>
                    </div>
                    <div class="state-item">
                        <div class="state-label">Target Temp</div>
                        <div class="state-value">
                            <span id="targetTemp">--</span><span class="state-unit">¬∞F</span>
                        </div>
                    </div>
                    <div class="state-item">
                        <div class="state-label">Fan Speed</div>
                        <div class="state-value">
                            <span id="fanSpeed">--</span><span class="state-unit">%</span>
                        </div>
                    </div>
                    <div class="state-item">
                        <div class="state-label">Time Left</div>
                        <div class="state-value">
                            <span id="timeRemaining">--</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="control-section">
                <h2>Mode</h2>
                <div class="mode-buttons">
                    <button class="mode-btn" data-mode="off">OFF</button>
                    <button class="mode-btn" data-mode="cool">COOL</button>
                    <button class="mode-btn" data-mode="heat">HEAT</button>
                    <button class="mode-btn" data-mode="turbo">TURBO</button>
                    <button class="mode-btn" data-mode="dry">DRY</button>
                    <button class="mode-btn" data-mode="ext_ht">EXT HT</button>
                </div>
            </div>

            <div class="control-section">
                <h2>Temperature</h2>
                <div class="slider-control">
                    <div class="slider-label">
                        <span>Set Temperature</span>
                        <span class="slider-value"><span id="tempSliderValue">72</span>¬∞F</span>
                    </div>
                    <input type="range" id="tempSlider" min="66" max="104" value="72" step="1">
                </div>
                <div class="preset-buttons" style="margin-top: 10px;">
                    <button class="preset-btn" id="tempDownBtn">TEMP ‚ñº</button>
                    <button class="preset-btn" id="tempUpBtn">TEMP ‚ñ≤</button>
                </div>
            </div>

            <div class="control-section">
                <h2>Fan Speed</h2>
                <div class="slider-control">
                    <div class="slider-label">
                        <span>Set Fan Speed</span>
                        <span class="slider-value"><span id="fanSliderValue">50</span>%</span>
                    </div>
                    <input type="range" id="fanSlider" min="5" max="100" value="50" step="5">
                </div>
                <div class="preset-buttons" style="margin-top: 10px;">
                    <button class="preset-btn" id="fanDownBtn">FAN ‚ñº</button>
                    <button class="preset-btn" id="fanUpBtn">FAN ‚ñ≤</button>
                </div>
            </div>

            <div class="control-section">
                <h2>Runtime / Timer</h2>
                <div class="slider-control">
                    <div class="slider-label">
                        <span>Set Runtime</span>
                        <span class="slider-value"><span id="runtimeValue">60</span> min</span>
                    </div>
                    <input type="range" id="runtimeSlider" min="1" max="600" value="60" step="1">
                </div>
            </div>

            <div class="control-section">
                <h2>Memory Presets</h2>
                <div class="preset-buttons">
                    <button class="preset-btn" data-preset="1">M1</button>
                    <button class="preset-btn" data-preset="2">M2</button>
                    <button class="preset-btn" data-preset="3">M3</button>
                </div>
            </div>
        </div>

        <div class="debug-section">
            <div class="debug-header" onclick="toggleDebugLog()">
                <div class="debug-title">üêõ Debug Log</div>
                <div class="debug-toggle" id="debugToggle">Hide ‚ñ≤</div>
            </div>
            <div class="debug-buttons">
                <button class="debug-btn" onclick="copyDebugLog()">üìã Copy Log</button>
                <button class="debug-btn" onclick="clearDebugLog()">üóëÔ∏è Clear</button>
                <button class="debug-btn" onclick="downloadDebugLog()">üíæ Download</button>
            </div>
            <div class="debug-log" id="debugLog"></div>
        </div>
    </div>

    <script>
        // BedJet Bluetooth UUIDs and Constants
        // Service UUID
        const BEDJET_SERVICE_UUID = '00001000-bed0-0080-aa55-4265644a6574';

        // Characteristic UUIDs (all under the same service)
        const BEDJET_STATUS_UUID = '00002000-bed0-0080-aa55-4265644a6574';
        const BEDJET_NAME_UUID = '00002001-bed0-0080-aa55-4265644a6574';
        const BEDJET_COMMAND_UUID = '00002004-bed0-0080-aa55-4265644a6574';

        const MODE_MAP = {
            0x01: 'off',
            0x02: 'cool',
            0x03: 'heat',
            0x04: 'turbo',
            0x05: 'dry',
            0x06: 'ext_ht'
        };

        const REVERSE_MODE_MAP = {
            'off': 0x01,
            'cool': 0x02,
            'heat': 0x03,
            'turbo': 0x04,
            'dry': 0x05,
            'ext_ht': 0x06
        };

        // State
        let device = null;
        let server = null;
        let commandCharacteristic = null;
        let currentMode = null;

        // Auto-reconnect state
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 10;
        let reconnectBaseDelay = 3000; // 3 seconds
        let reconnectTimer = null;
        let isReconnecting = false;
        let userDisconnected = false;

        // Debug logging
        let debugLogContent = '';
        const debugLogEl = document.getElementById('debugLog');

        function logDebug(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false, fractionalSecondDigits: 3 });
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';

            const timeSpan = document.createElement('span');
            timeSpan.className = 'log-time';
            timeSpan.textContent = `[${timestamp}] `;

            const levelSpan = document.createElement('span');
            levelSpan.className = `log-level-${level}`;
            levelSpan.textContent = message;

            logEntry.appendChild(timeSpan);
            logEntry.appendChild(levelSpan);
            debugLogEl.appendChild(logEntry);

            // Auto-scroll to bottom
            debugLogEl.scrollTop = debugLogEl.scrollHeight;

            // Also log to console
            console.log(`[${timestamp}] ${message}`);

            // Keep text content for copying
            debugLogContent += `[${timestamp}] ${message}\n`;
        }

        function clearDebugLog() {
            debugLogContent = '';
            debugLogEl.innerHTML = '';
            logDebug('Debug log cleared', 'info');
        }

        function copyDebugLog() {
            if (!debugLogContent) {
                alert('No logs to copy');
                return;
            }

            navigator.clipboard.writeText(debugLogContent).then(() => {
                logDebug('Log copied to clipboard!', 'success');
                setTimeout(() => alert('Debug log copied to clipboard!'), 100);
            }).catch(err => {
                // Fallback for mobile browsers
                const textArea = document.createElement('textarea');
                textArea.value = debugLogContent;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    logDebug('Log copied to clipboard (fallback)!', 'success');
                    alert('Debug log copied to clipboard!');
                } catch (e) {
                    logDebug('Failed to copy: ' + e.message, 'error');
                    alert('Failed to copy. Error: ' + e.message);
                }
                document.body.removeChild(textArea);
            });
        }

        function downloadDebugLog() {
            if (!debugLogContent) {
                alert('No logs to download');
                return;
            }

            const blob = new Blob([debugLogContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bedjet-debug-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            logDebug('Log downloaded', 'success');
        }

        function toggleDebugLog() {
            const section = document.querySelector('.debug-section');
            const toggle = document.getElementById('debugToggle');

            if (section.classList.contains('debug-collapsed')) {
                section.classList.remove('debug-collapsed');
                toggle.textContent = 'Hide ‚ñ≤';
            } else {
                section.classList.add('debug-collapsed');
                toggle.textContent = 'Show ‚ñº';
            }
        }

        // UI Elements
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const deviceName = document.getElementById('deviceName');
        const controls = document.getElementById('controls');
        const errorDiv = document.getElementById('error');

        // State displays
        const currentTempEl = document.getElementById('currentTemp');
        const targetTempEl = document.getElementById('targetTemp');
        const fanSpeedEl = document.getElementById('fanSpeed');
        const timeRemainingEl = document.getElementById('timeRemaining');

        // Controls
        const modeButtons = document.querySelectorAll('.mode-btn');
        const tempSlider = document.getElementById('tempSlider');
        const tempSliderValue = document.getElementById('tempSliderValue');
        const tempUpBtn = document.getElementById('tempUpBtn');
        const tempDownBtn = document.getElementById('tempDownBtn');
        const fanSlider = document.getElementById('fanSlider');
        const fanSliderValue = document.getElementById('fanSliderValue');
        const fanUpBtn = document.getElementById('fanUpBtn');
        const fanDownBtn = document.getElementById('fanDownBtn');
        const runtimeSlider = document.getElementById('runtimeSlider');
        const runtimeValue = document.getElementById('runtimeValue');
        const presetButtons = document.querySelectorAll('.preset-btn');

        // Check Web Bluetooth support
        if (!navigator.bluetooth) {
            showError('Web Bluetooth API is not supported in this browser. Please use Chrome, Edge, or Opera.');
            connectBtn.disabled = true;
            logDebug('‚ùå Web Bluetooth API not supported in this browser', 'error');
            logDebug('User Agent: ' + navigator.userAgent, 'info');
        } else {
            logDebug('‚úì Web Bluetooth API is available', 'success');
            logDebug('User Agent: ' + navigator.userAgent, 'info');
        }

        // Event Listeners
        connectBtn.addEventListener('click', connectToBedJet);
        disconnectBtn.addEventListener('click', disconnect);

        modeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const mode = btn.dataset.mode;
                setMode(mode);
            });
        });

        tempSlider.addEventListener('input', (e) => {
            tempSliderValue.textContent = e.target.value;
        });

        tempSlider.addEventListener('change', (e) => {
            setTemperature(parseInt(e.target.value));
        });

        fanSlider.addEventListener('input', (e) => {
            fanSliderValue.textContent = e.target.value;
        });

        fanSlider.addEventListener('change', (e) => {
            setFanSpeed(parseInt(e.target.value));
        });

        runtimeSlider.addEventListener('input', (e) => {
            runtimeValue.textContent = e.target.value;
        });

        runtimeSlider.addEventListener('change', (e) => {
            setRuntime(parseInt(e.target.value));
        });

        tempUpBtn.addEventListener('click', () => {
            incrementTemperature();
        });

        tempDownBtn.addEventListener('click', () => {
            decrementTemperature();
        });

        fanUpBtn.addEventListener('click', () => {
            incrementFan();
        });

        fanDownBtn.addEventListener('click', () => {
            decrementFan();
        });

        presetButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const preset = parseInt(btn.dataset.preset);
                activatePreset(preset);
            });
        });

        async function connectToBedJet() {
            try {
                hideError();
                statusText.textContent = 'Scanning...';

                // Reset reconnect state
                userDisconnected = false;
                reconnectAttempts = 0;
                if (reconnectTimer) {
                    clearTimeout(reconnectTimer);
                    reconnectTimer = null;
                }

                const showAll = document.getElementById('showAllDevices').checked;
                logDebug('=== Starting BedJet Connection ===', 'info');
                logDebug(`Show all devices mode: ${showAll}`, 'info');

                // Request BedJet device with fallback options
                const requestOptions = {
                    optionalServices: [
                        BEDJET_SERVICE_UUID
                    ]
                };

                if (showAll) {
                    // Fallback: show all devices (useful if service UUIDs aren't advertised)
                    requestOptions.acceptAllDevices = true;
                    logDebug('Using acceptAllDevices mode (fallback)', 'warn');
                } else {
                    // Default: filter by service UUIDs and name prefix
                    requestOptions.filters = [
                        { services: [BEDJET_SERVICE_UUID] },
                        { namePrefix: 'BedJet' },
                        { namePrefix: 'BEDJET' }
                    ];
                    logDebug('Scanning with filters:', 'info');
                    logDebug(`  - Service UUID: ${BEDJET_SERVICE_UUID}`, 'info');
                    logDebug(`  - Name prefixes: BedJet, BEDJET`, 'info');
                }

                logDebug('Requesting Bluetooth device...', 'info');
                device = await navigator.bluetooth.requestDevice(requestOptions);

                logDebug(`‚úì Device selected: ${device.name || 'Unknown'}`, 'success');
                logDebug(`  Device ID: ${device.id}`, 'info');
                logDebug(`  Device GATT connected: ${device.gatt.connected}`, 'info');

                statusText.textContent = 'Connecting...';
                device.addEventListener('gattserverdisconnected', onDisconnected);

                logDebug('Connecting to GATT server...', 'info');
                server = await device.gatt.connect();
                logDebug('‚úì Connected to GATT server', 'success');

                // Get the BedJet service (all characteristics are under this one service)
                logDebug(`Getting BedJet service (${BEDJET_SERVICE_UUID})...`, 'info');
                const bedjetService = await server.getPrimaryService(BEDJET_SERVICE_UUID);
                logDebug('‚úì Got BedJet service', 'success');

                // Get command characteristic (for sending commands)
                logDebug(`Getting command characteristic (${BEDJET_COMMAND_UUID})...`, 'info');
                commandCharacteristic = await bedjetService.getCharacteristic(BEDJET_COMMAND_UUID);
                logDebug('‚úì Got command characteristic', 'success');
                logDebug(`  Properties: ${Array.from(commandCharacteristic.properties).join(', ')}`, 'info');

                // Get status characteristic (for receiving status updates)
                logDebug(`Getting status characteristic (${BEDJET_STATUS_UUID})...`, 'info');
                const statusCharacteristic = await bedjetService.getCharacteristic(BEDJET_STATUS_UUID);
                logDebug('‚úì Got status characteristic', 'success');
                logDebug(`  Properties: ${Array.from(statusCharacteristic.properties).join(', ')}`, 'info');

                // Subscribe to status notifications
                logDebug('Starting notifications...', 'info');
                await statusCharacteristic.startNotifications();
                statusCharacteristic.addEventListener('characteristicvaluechanged', handleStatusUpdate);
                logDebug('‚úì Notifications enabled', 'success');

                // Read device name
                try {
                    logDebug(`Getting name characteristic (${BEDJET_NAME_UUID})...`, 'info');
                    const nameCharacteristic = await bedjetService.getCharacteristic(BEDJET_NAME_UUID);
                    const nameValue = await nameCharacteristic.readValue();
                    const name = new TextDecoder().decode(nameValue);
                    deviceName.textContent = name || device.name;
                    logDebug(`‚úì Device name: ${name || device.name}`, 'success');
                } catch (err) {
                    deviceName.textContent = device.name;
                    logDebug(`‚ö† Could not read device name: ${err.message}`, 'warn');
                }

                // Update UI
                updateConnectionStatus(true);
                controls.style.display = 'block';
                connectBtn.style.display = 'none';
                disconnectBtn.style.display = 'block';

                logDebug('=== Connection Complete ===', 'success');

            } catch (error) {
                console.error('Connection failed:', error);
                logDebug(`‚ùå Connection failed: ${error.name} - ${error.message}`, 'error');
                if (error.stack) {
                    logDebug(`Stack: ${error.stack}`, 'error');
                }
                showError(`Failed to connect: ${error.message}`);
                updateConnectionStatus(false);
            }
        }

        async function disconnect() {
            logDebug('User requested disconnect', 'info');
            userDisconnected = true;

            // Clear any pending reconnect attempts
            if (reconnectTimer) {
                clearTimeout(reconnectTimer);
                reconnectTimer = null;
            }

            if (device && device.gatt.connected) {
                device.gatt.disconnect();
                logDebug('Disconnect command sent', 'info');
            } else {
                logDebug('No active connection to disconnect', 'warn');
            }
        }

        async function attemptReconnect() {
            if (userDisconnected || isReconnecting) {
                return;
            }

            isReconnecting = true;
            reconnectAttempts++;

            const delayMs = reconnectBaseDelay * reconnectAttempts; // Linear backoff
            logDebug(`Reconnect attempt ${reconnectAttempts}/${maxReconnectAttempts} in ${delayMs/1000}s...`, 'warn');

            reconnectTimer = setTimeout(async () => {
                try {
                    logDebug(`Attempting to reconnect to ${device?.name || 'BedJet'}...`, 'info');

                    if (device && device.gatt) {
                        server = await device.gatt.connect();
                        logDebug('‚úì Reconnected to GATT server', 'success');

                        // Re-establish characteristics
                        const bedjetService = await server.getPrimaryService(BEDJET_SERVICE_UUID);
                        commandCharacteristic = await bedjetService.getCharacteristic(BEDJET_COMMAND_UUID);

                        const statusCharacteristic = await bedjetService.getCharacteristic(BEDJET_STATUS_UUID);
                        await statusCharacteristic.startNotifications();
                        statusCharacteristic.addEventListener('characteristicvaluechanged', handleStatusUpdate);

                        // Update UI
                        updateConnectionStatus(true);
                        controls.style.display = 'block';
                        connectBtn.style.display = 'none';
                        disconnectBtn.style.display = 'block';

                        // Reset reconnect state
                        reconnectAttempts = 0;
                        isReconnecting = false;

                        logDebug('=== Reconnection Complete ===', 'success');
                    }
                } catch (error) {
                    logDebug(`Reconnect attempt ${reconnectAttempts} failed: ${error.message}`, 'error');
                    isReconnecting = false;

                    if (reconnectAttempts < maxReconnectAttempts) {
                        attemptReconnect();
                    } else {
                        logDebug(`Max reconnect attempts (${maxReconnectAttempts}) reached. Giving up.`, 'error');
                        showError('Connection lost. Please reconnect manually.');
                    }
                }
            }, delayMs);
        }

        function onDisconnected() {
            logDebug('Device disconnected', 'warn');
            logDebug(`Device: ${device?.name || 'Unknown'}`, 'info');
            updateConnectionStatus(false);
            controls.style.display = 'none';
            connectBtn.style.display = 'block';
            disconnectBtn.style.display = 'none';
            deviceName.textContent = '';
            currentMode = null;
            updateModeButtons();

            // Attempt auto-reconnect if not user-initiated
            if (!userDisconnected) {
                logDebug('Unexpected disconnect - initiating auto-reconnect', 'warn');
                attemptReconnect();
            } else {
                logDebug('User-initiated disconnect - auto-reconnect disabled', 'info');
            }
        }

        function handleStatusUpdate(event) {
            const data = new Uint8Array(event.target.value.buffer);

            if (data.length >= 15) {
                const hexData = Array.from(data).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' ');
                console.log('Status data:', hexData);
                logDebug(`‚óÑ Status update (${data.length} bytes): ${hexData}`, 'info');

                // Parse current temperature (byte 7)
                if (data[7] !== 0 && data[7] !== 0x26) {
                    const rawCurrent = data[7] - 0x26;
                    const currentTemp = Math.round((rawCurrent + 66) - (rawCurrent / 9));
                    currentTempEl.textContent = currentTemp;
                    logDebug(`  Current temp: ${currentTemp}¬∞F (byte[7]=0x${data[7].toString(16)})`, 'info');
                }

                // Parse target temperature (byte 8)
                if (data[8] !== 0 && data[8] !== 0x26) {
                    const rawTarget = data[8] - 0x26;
                    const targetTemp = Math.round((rawTarget + 66) - (rawTarget / 9));
                    targetTempEl.textContent = targetTemp;
                    logDebug(`  Target temp: ${targetTemp}¬∞F (byte[8]=0x${data[8].toString(16)})`, 'info');
                }

                // Parse fan speed (byte 10)
                if (data[10] > 0) {
                    const fanSpeed = data[10] * 5;
                    fanSpeedEl.textContent = fanSpeed;
                    logDebug(`  Fan speed: ${fanSpeed}% (byte[10]=0x${data[10].toString(16)})`, 'info');
                }

                // Parse time remaining (bytes 4, 5, 6)
                const hours = data[4];
                const minutes = data[5];
                const seconds = data[6];
                const totalSeconds = hours * 3600 + minutes * 60 + seconds;

                if (totalSeconds > 0) {
                    const h = Math.floor(totalSeconds / 3600);
                    const m = Math.floor((totalSeconds % 3600) / 60);
                    const s = totalSeconds % 60;
                    const timeStr = `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                    timeRemainingEl.textContent = timeStr;
                    logDebug(`  Time remaining: ${timeStr}`, 'info');
                } else {
                    timeRemainingEl.textContent = '--';
                }

                // Parse mode (bytes 13, 14)
                const byte13 = data[13];
                const byte14 = data[14];

                let detectedMode = null;
                if (byte14 === 0x50 && byte13 === 0x14) {
                    detectedMode = 'off';
                } else if (byte14 === 0x34) {
                    detectedMode = 'cool';
                } else if (byte14 === 0x56) {
                    detectedMode = 'turbo';
                } else if (byte14 === 0x50 && byte13 === 0x2d) {
                    detectedMode = 'heat';
                } else if (byte14 === 0x3e) {
                    detectedMode = 'dry';
                } else if (byte14 === 0x43) {
                    detectedMode = 'ext_ht';
                }

                if (detectedMode) {
                    currentMode = detectedMode;
                    logDebug(`  Mode: ${detectedMode.toUpperCase()} (byte[13]=0x${byte13.toString(16)}, byte[14]=0x${byte14.toString(16)})`, 'info');
                } else {
                    logDebug(`  Unknown mode (byte[13]=0x${byte13.toString(16)}, byte[14]=0x${byte14.toString(16)})`, 'warn');
                }

                updateModeButtons();
            } else {
                logDebug(`‚ö† Status update too short: ${data.length} bytes (expected ‚â•15)`, 'warn');
            }
        }

        function updateModeButtons() {
            modeButtons.forEach(btn => {
                if (btn.dataset.mode === currentMode) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        async function sendCommand(command) {
            if (!commandCharacteristic) {
                showError('Not connected to BedJet');
                logDebug('‚ùå Cannot send command: Not connected', 'error');
                return;
            }

            try {
                const commandArray = new Uint8Array(command);
                const hexCommand = Array.from(commandArray).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' ');
                console.log('Sending command:', hexCommand);
                logDebug(`‚ñ∫ Sending command: ${hexCommand}`, 'info');

                await commandCharacteristic.writeValue(commandArray);
                logDebug('‚úì Command sent successfully', 'success');

                await new Promise(resolve => setTimeout(resolve, 300));
            } catch (error) {
                console.error('Command failed:', error);
                logDebug(`‚ùå Command failed: ${error.message}`, 'error');
                showError(`Command failed: ${error.message}`);
            }
        }

        async function setMode(mode) {
            logDebug(`Setting mode to: ${mode.toUpperCase()}`, 'info');
            const modeByte = REVERSE_MODE_MAP[mode];
            if (modeByte === undefined) {
                showError(`Invalid mode: ${mode}`);
                logDebug(`‚ùå Invalid mode: ${mode}`, 'error');
                return;
            }
            logDebug(`  Mode byte: 0x${modeByte.toString(16)}`, 'info');
            await sendCommand([0x01, modeByte]);
        }

        async function setTemperature(temp) {
            logDebug(`Setting temperature to: ${temp}¬∞F`, 'info');
            if (temp < 66 || temp > 104) {
                showError(`Temperature ${temp} out of range (66-104¬∞F)`);
                logDebug(`‚ùå Temperature ${temp}¬∞F out of range (66-104¬∞F)`, 'error');
                return;
            }

            // Convert temperature to BedJet format (matches Python implementations)
            // Formula: temp_byte = (temp - 60) / 9 + (temp - 66) + 0x26
            const tempByte = Math.round((temp - 60) / 9 + (temp - 66) + 0x26);
            const clampedByte = Math.max(0, Math.min(255, tempByte));

            console.log(`Setting temperature ${temp}¬∞F (byte: 0x${clampedByte.toString(16)})`);
            logDebug(`  Temp byte: 0x${clampedByte.toString(16)}`, 'info');
            await sendCommand([0x03, clampedByte]);
        }

        async function setFanSpeed(speed) {
            logDebug(`Setting fan speed to: ${speed}%`, 'info');
            if (speed < 5 || speed > 100) {
                showError(`Fan speed ${speed} out of range (5-100%)`);
                logDebug(`‚ùå Fan speed ${speed}% out of range (5-100%)`, 'error');
                return;
            }

            // Convert percentage to BedJet format
            const fanByte = Math.round(speed / 5) - 1;
            logDebug(`  Fan byte: 0x${fanByte.toString(16)}`, 'info');
            await sendCommand([0x07, fanByte]);
        }

        async function setRuntime(minutes) {
            logDebug(`Setting runtime to: ${minutes} minutes`, 'info');
            if (minutes < 1 || minutes > 600) {
                showError(`Runtime ${minutes} out of range (1-600 minutes)`);
                logDebug(`‚ùå Runtime ${minutes} min out of range (1-600 min)`, 'error');
                return;
            }

            // Convert minutes to hours and minutes
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;

            logDebug(`  Runtime: ${hours}h ${mins}m`, 'info');
            await sendCommand([0x02, hours, mins]);
        }

        async function incrementTemperature() {
            logDebug('Increment temperature button pressed', 'info');
            await sendCommand([0x01, 0x12]); // TEMP_UP command
        }

        async function decrementTemperature() {
            logDebug('Decrement temperature button pressed', 'info');
            await sendCommand([0x01, 0x13]); // TEMP_DOWN command
        }

        async function incrementFan() {
            logDebug('Increment fan speed button pressed', 'info');
            await sendCommand([0x01, 0x10]); // FAN_UP command
        }

        async function decrementFan() {
            logDebug('Decrement fan speed button pressed', 'info');
            await sendCommand([0x01, 0x11]); // FAN_DOWN command
        }

        async function activatePreset(preset) {
            logDebug(`Activating memory preset: M${preset}`, 'info');
            if (preset < 1 || preset > 3) {
                showError(`Invalid preset: ${preset}`);
                logDebug(`‚ùå Invalid preset: ${preset}`, 'error');
                return;
            }

            const presetByte = 0x20 + (preset - 1);
            logDebug(`  Preset byte: 0x${presetByte.toString(16)}`, 'info');
            await sendCommand([0x01, presetByte]);
        }

        function updateConnectionStatus(connected) {
            if (connected) {
                statusIndicator.classList.add('connected');
                statusText.textContent = 'Connected';
            } else {
                statusIndicator.classList.remove('connected');
                statusText.textContent = 'Not Connected';
            }
        }

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            setTimeout(() => hideError(), 5000);
        }

        function hideError() {
            errorDiv.classList.remove('show');
        }
    </script>
</body>
</html>
